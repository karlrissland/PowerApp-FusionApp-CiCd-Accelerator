########################################################################
# This workflow will deploy all app components to a specific environment
########################################################################
name: Deploy To Environment

on:
  workflow_call:
    inputs:
      environment:
        description: 'environment to deploy solution to'
        required: true
        type: string

  workflow_dispatch:
    inputs:
      environment:
        description: 'environment to deploy solution to'
        required: true
        type: environment
        
permissions:
  id-token: write
  contents: read
  
#######################################################################
# Need to call deploy-powerapp-solution.yml for each solution so we   #
# pass in the settings for each solution.  Have not found a way to    #
# programatically select a variable for use.                           #
#######################################################################

jobs:
  ##############################################################
  # Need to setup variables in a job and pass as output as you #
  # can't seem to use an environment when calling a reusable   #
  # workflow.                                                  #
  ##############################################################
  variablesetup:
    environment: ${{ github.event.inputs.environment}}
    runs-on: windows-latest
    steps:
      - name: setvariables
        run: |
          write-host environment ${{ github.event.inputs.environment }}
        shell: pwsh
    outputs:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      ALMLAB_SETTINGS_FILE: ${{ vars.ALMLab_SETTINGSFILE }}
      GITHUB_SETTINGS_FILE: ${{ vars.XGITHUB_SETTINGSFILE }}

  ALMLAB-call-powerapp-solution-deployment:
     uses: ./.github/workflows/deploy-powerapp-solution.yml
     needs: variablesetup
     with:
       environment: ${{ inputs.environment }}
       settingsfilecontents: ${{ needs.variablesetup.outputs.ALMLAB_SETTINGS_FILE }}
       solutionName: "ALMLAB"
     secrets: inherit
  
  #GITHUB-call-powerapp-solution-deployment: 
  #  uses: ./.github/workflows/deploy-powerapp-solution.yml
  #  needs: variablesetup
  #  with:
  #    environment: ${{ needs.variablesetup.outputs.ENVIRONMENT }}
  #    settingsfilecontents: ${{ needs.variablesetup.outputs.GITHUB_SETTINGS_FILE }}
  #    solutionName: "GITHUB"
  #  secrets: inherit
  
  ################################################  
  # Use this template to call reusable workflows #
  # to deploy other parts of the app             #
  ################################################
  #APPX-call-prodev-solution-deployment
  #  uses: ./.github/workflows/prodev-deployment.yml
  #  needs: variablesetup
  #  with:
  #    environment: ${{ inputs.environment }}
  #    <other variables to pass>
  #  secrets: inherit
  
  #debugvariables:
  #  runs-on: windows-latest
  #  needs: variablesetup
  #  steps:
  #    - run: |
  #        write-host environment ${{ needs.variablesetup.outputs.ENVIRONMENT }}
  #        write-host almlab settings ${{ needs.variablesetup.outputs.ALMLAB_SETTINGS_FILE }}
  #        write-host github settings ${{ needs.variablesetup.outputs.GITHUB_SETTINGS_FILE }}
  #      shell: pwsh


